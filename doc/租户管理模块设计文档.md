# 租户管理模块设计文档

**版本**：1.0

**最后更新时间**：2026年1月16日  

**作者**：纪成林

---

## 1. 模块概述

本模块为分布式系统提供**完全无状态**的多租户（Multi-tenancy）管理能力，负责租户的全生命周期操作（创建、查询、更新、删除）。所有租户状态（包括元数据、配额、用量等）**仅持久化于外部强一致性存储 etcd**，服务实例自身不保存任何会话、缓存或本地状态。

该设计严格遵循云原生和微服务架构原则，支持任意实例的弹性扩缩容、快速启停与故障迁移，适用于 Kubernetes、Service Mesh 等现代化部署环境。

---

## 2. 设计目标

- ✅ **无状态性**：服务实例不维护任何本地状态，请求可由任意实例处理  
- ✅ **强一致性**：依赖 etcd 的线性一致读写保障数据正确性  
- ✅ **高可用 & 弹性**：支持水平扩展，实例可随时销毁或替换  
- ✅ **并发安全**：通过 etcd 的 Compare-and-Swap（CAS）机制实现乐观锁  
- ✅ **标准化接口**：提供符合 OpenAPI 3.0 规范的 RESTful API  
- ✅ **可观测性**：记录操作时间戳，便于审计、监控与告警  

---

## 3. 数据模型

### 3.1 数据结构示例
```json
{
  "tenant_id": "t-abc123",
  "quotas": {
    "instanceCount": {
      "limit": 1000,
      "unit": "count",
      "is_hard": true
    }
  },
  "usages": {
    "instanceCount": 890
  },
  "last_updated": "2026-01-16T10:15:00Z"
}
```

### 4.3 字段说明

| 字段           | 类型             | 必填 | 说明                           |
| -------------- | ---------------- | ---- | ------------------------------ |
| `tenant_id`    | string           | 是   | 租户唯一标识                   |
| `quotas`       | map\             | 是   | 资源配额定义                   |
| `usages`       | map\             | 是   | 当前资源用量（由上层业务更新） |
| `last_updated` | RFC3339 datetime | 是   | UTC 时间戳，服务自动设置       |

#### Quota 结构
| 字段                            | 类型        | 说明                                    |
| ------------------------------- | ----------- | --------------------------------------- |
| `limit`                         | integer     | 资源上限                                |
| `unit`                          | string      | 单位（如 `"cores"`, `"GB"`, `"count"`） |
| `is_hard`                       | boolean     | 是否硬限制（true 表示超限拒绝）         |
| `warning_threshold`（暂不实行） | float (0~1) | 告警阈值比例（如 0.85 = 85%）           |

---

## 5. 对外 API 接口（RESTful）

### 5.1 基础信息
- **Base URL**：`/serverless/v1`
- **Content-Type**：`application/json`
- **认证**：由 iam模块处理（本模块不实现）

### 5.2 接口列表

| 方法     | 路径                   | 功能         | 幂等性                 |
| -------- | ---------------------- | ------------ | ---------------------- |
| `POST`   | `/tenants`             | 创建新租户   | 否（重复创建返回 409） |
| `GET`    | `/tenants`             | 列出租户     | 是                     |
| `GET`    | `/tenants/{tenant_id}` | 获取租户详情 | 是                     |
| `PUT`    | `/tenants/{tenant_id}` | 更新租户     | 否                     |
| `DELETE` | `/tenants/{tenant_id}` | 删除租户     | 是                     |

### 5.3 错误码规范

| HTTP 状态码                 | 含义                           |
| --------------------------- | ------------------------------ |
| `200 OK`                    | 成功更新                       |
| `201 Created`               | 成功创建                       |
| `204 No Content`            | 成功删除                       |
| `400 Bad Request`           | 请求体格式错误、字段缺失或非法 |
| `404 Not Found`             | 租户不存在                     |
| `409 Conflict`              | 并发修改冲突（etcd CAS 失败）  |
| `500 Internal Server Error` | etcd 连接失败或内部错误        |

---

## 6. 核心操作流程（无状态实现）

### 6.1 创建租户（Create）
1. 校验 `tenant_id` 格式（正则：`^t-[a-zA-Z0-9]+$`）
2. 调用 `etcd.Get(/tenants/{id})` 检查是否已存在
3. 若存在 → 返回 `409 Conflict`
4. 若不存在 → 构造新数据（设置 `last_updated = now()`）
5. 调用 `etcd.Put()` 写入
6. 返回 `201 Created`

> 🔁 **无状态**：全程无中间状态保留。

### 6.2 更新租户（Update）
1. 从请求路径获取 `tenant_id`
2. **立即调用 `etcd.Get(key)` 获取当前值及 `ModRevision`**
3. 若未找到 → 返回 `404`
4. 反序列化当前租户数据
5. 应用请求中的更新（如修改 `usages`）
6. 设置 `last_updated = time.Now().UTC()`
7. **构造 etcd 事务**：
   ```go
   txn := client.Txn(ctx).
     If(Compare(ModRevision(key), "=", oldRev)).
     Then(OpPut(key, newJSON))
   ```
8. 执行事务：
   - 成功 → 返回 `200` + 新数据
   - 失败（`txn.Succeeded == false`）→ 返回 `409 Conflict`

> ✅ **完全无状态**：读、校验、写在**单次 HTTP 请求内原子完成**，不依赖跨请求状态。

### 6.3 查询与删除
- **Get**：直接 `etcd.Get()`，返回结果
- **Delete**：直接 `etcd.Delete()`，返回 `204`
- **List**：使用 `etcd.Get(prefix, WithPrefix())` （暂不支持分页）

### 6.4 Quota检查

当用户请求到达时，先检查目标租户的quota是否满足请求，例如对Function进行Create请求时，检查Function所属租户的quota是否能满足需求，如果不能满足则通过Admit返回错误，拒绝该请求

---

## 11. 安全考虑

- **权限最小化**：etcd 客户端使用受限账号，仅允许操作 `/tenants/` 前缀
- **输入校验**：严格校验 `tenant_id`、`status`、`quotas` 结构
- **审计日志**：记录关键操作（Create/Update/Delete）到中央日志系统
