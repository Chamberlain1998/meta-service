openapi: 3.0.3
info:
  title: MetaService Serverless Platform API
  version: 1.0.0
  description: |
    多租户无状态云原生平台的元数据与权限管理接口。
    所有操作均需通过 IAM 认证 \+ tenantMgr 配额检查 \+ RBAC 权限校验。
    所有接口需要通过 JwtAuth 或 AccessKeyAuth 其中一种认证方式访问。
servers:
  - url: /serverless/v1

security:
  - JwtAuth: [ ]
  - AccessKeyAuth: [ ]

tags:
  - name: Tenant
    description: 租户管理
  - name: RBAC
    description: 角色与绑定管理
  - name: Authz
    description: 权限检查

paths:
  # ========== 租户管理 ==========
  /tenants:
    post:
      tags: [ Tenant ]
      summary: 创建新租户
      operationId: createTenant
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TenantCreateRequest'
      responses:
        '201':
          description: 成功创建
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tenant'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: 租户 ID 已存在
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

    get:
      tags: [ Tenant ]
      summary: 列出租户
      operationId: listTenants
      responses:
        '200':
          description: 租户列表
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Tenant'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /tenants/{tenant_id}:
    get:
      tags: [ Tenant ]
      summary: 获取租户详情
      operationId: getTenant
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tenant'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    patch:
      tags: [ Tenant ]
      summary: 部分更新租户（支持更新配额/状态等，不支持改 ID）
      operationId: updateTenant
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TenantUpdateRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tenant'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: 并发修改冲突（etcd CAS 失败）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags: [ Tenant ]
      summary: 删除租户
      operationId: deleteTenant
      parameters:
        - name: tenant_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: 成功删除
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # ========== 函数管理 ==========
  # 预留，后续按需补充

  # ========== RBAC - Role ==========
  /roles:
    post:
      tags: [ RBAC ]
      summary: 在当前租户下创建角色
      operationId: createRole
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleCreateRequest'
      responses:
        '201':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /roles/{role_id}:
    get:
      tags: [ RBAC ]
      summary: 获取角色详情
      operationId: getRole
      parameters:
        - name: role_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags: [ RBAC ]
      summary: 更新角色
      operationId: updateRole
      parameters:
        - name: role_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleUpdateRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags: [ RBAC ]
      summary: 删除角色
      operationId: deleteRole
      parameters:
        - name: role_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: 成功删除
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # ========== RBAC - RoleBinding ==========
  /rolebindings:
    post:
      tags: [ RBAC ]
      summary: 创建角色绑定
      operationId: createRoleBinding
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleBindingCreateRequest'
      responses:
        '201':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoleBinding'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /rolebindings/{rolebinding_id}:
    get:
      tags: [ RBAC ]
      summary: 获取角色绑定详情
      operationId: getRoleBinding
      parameters:
        - name: rolebinding_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoleBinding'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags: [ RBAC ]
      summary: 删除角色绑定
      operationId: deleteRoleBinding
      parameters:
        - name: rolebinding_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: 成功删除
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # ========== 鉴权检查（供内部调用）==========
  /authz:
    post:
      tags: [ Authz ]
      summary: 检查主体是否有权限执行某操作
      operationId: checkAuthorization
      # 只允许内部调用，在此覆盖 security
      security:
        - JwtAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthzRequest'
      responses:
        '200':
          description: 鉴权检查完成（无论允许或拒绝都返回 200）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthzResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  schemas:

    Tenant:
      type: object
      required: [ tenant_id, quotas, usages, created_at, last_updated ]
      properties:
        tenant_id:
          type: string
          description: 租户唯一标识，如 t\-analytics
        status:
          type: string
          enum: [ active, suspended ]
          default: active
        quotas:
          $ref: '#/components/schemas/QuotasMap'
        usages:
          $ref: '#/components/schemas/UsagesMap'
        metadata:
          $ref: '#/components/schemas/Metadata'
        created_at:
          type: string
          format: date-time
          description: 资源创建时间
        last_updated:
          type: string
          format: date-time
          description: 最近一次变更时间

    QuotasMap:
      type: object
      description: |
        配额键值对，如：
        \- cpu_cores
        \- memory_gb
        \- functions
      additionalProperties:
        $ref: '#/components/schemas/Quota'

    UsagesMap:
      type: object
      description: 与配额键对应的实际使用量
      additionalProperties:
        type: integer

    Quota:
      type: object
      properties:
        limit:
          type: integer
          minimum: 0
        unit:
          type: string
          enum: [ count, cores, MB, GB, TB, requests_per_second, concurrent_instances ]
        is_hard:
          type: boolean
          description: 是否为硬限制（true 表示超限直接拒绝）
      required: [ limit, unit, is_hard ]

    TenantCreateRequest:
      type: object
      required: [ tenant_id, quotas ]
      properties:
        tenant_id:
          type: string
        quotas:
          $ref: '#/components/schemas/QuotasMap'

    TenantUpdateRequest:
      type: object
      properties:
        status:
          type: string
          enum: [ active, suspended ]
        quotas:
          $ref: '#/components/schemas/QuotasMap'

    Role:
      type: object
      description: 角色对象（服务端返回）
      required: [ id, tenant, rules, created_at, last_updated ]
      properties:
        id:
          type: string
        tenant:
          type: string
        rules:
          type: array
          items:
            $ref: '#/components/schemas/RoleRule'
        metadata:
          $ref: '#/components/schemas/Metadata'
        created_at:
          type: string
          format: date-time
          description: 资源创建时间
        last_updated:
          type: string
          format: date-time
          description: 最近一次变更时间

    RoleRule:
      type: object
      required: [ resources, verbs ]
      properties:
        resources:
          type: array
          items:
            $ref: '#/components/schemas/RoleResource'
        verbs:
          type: array
          items:
            type: string
            enum: [ create, invoke, exit, save_state, load_state, kill, update, delete, get, list ]

    RoleResource:
      type: object
      required: [ type, selector ]
      properties:
        type:
          type: string
          enum: [ function, instance, tenant ]
        selector:
          type: array
          description: 资源选择器，如函数名、实例 ID 或租户 ID
          items:
            type: string
          minItems: 1

    RoleCreateRequest:
      type: object
      required: [ tenant, rules ]
      properties:
        tenant:
          type: string
        rules:
          type: array
          items:
            $ref: '#/components/schemas/RoleRule'

    RoleUpdateRequest:
      type: object
      properties:
        rules:
          type: array
          items:
            $ref: '#/components/schemas/RoleRule'

    RoleBinding:
      type: object
      description: 角色绑定（服务端返回）
      required: [ id, role_id, subject, tenant, created_at, last_updated ]
      properties:
        id:
          type: string
        role_id:
          type: string
        subject:
          type: string
        tenant:
          type: string
        metadata:
          $ref: '#/components/schemas/Metadata'
        created_at:
          type: string
          format: date-time
          description: 资源创建时间
        last_updated:
          type: string
          format: date-time
          description: 最近一次变更时间

    RoleBindingCreateRequest:
      type: object
      required: [ role_id, subject, tenant ]
      properties:
        role_id:
          type: string
        subject:
          type: string
        tenant:
          type: string


    AuthzRequest:
      type: object
      required: [ subject, context_tenant, resource, verb ]
      properties:
        subject:
          type: string
        context_tenant:
          type: string
          example: 't-platform'
        resource:
          $ref: '#/components/schemas/ResourceIdentifier'
        verb:
          type: string
          enum: [ create, invoke, exit, save_state, load_state, kill, update, delete, get, list ]

    ResourceIdentifier:
      type: object
      required: [ type, id ]
      properties:
        type:
          type: string
          enum: [ function, instance, tenant, role, role_binding ]
        id:
          type: string
          minLength: 1
          description: 资源唯一标识，如函数名、实例 ID、租户 ID 等

    AuthzResponse:
      type: object
      required: [ allowed ]
      properties:
        allowed:
          type: boolean
          description: 是否允许访问
        reason:
          type: string
          description: 拒绝原因（当 allowed 为 false 时）

    Metadata:
      type: object
      description: 资源元数据，支持标签和注解
      properties:
        labels:
          type: object
          additionalProperties:
            type: string
          description: 标签，用于分类和筛选
        annotations:
          type: object
          additionalProperties:
            type: string
          description: 注解，用于存储额外的非标识性信息

    ErrorResponse:
      type: object
      required: [ code, message ]
      properties:
        code:
          type: string
          description: 标准错误码
          enum:
            - INVALID_REQUEST
            - UNAUTHORIZED
            - FORBIDDEN
            - NOT_FOUND
            - CONFLICT
            - INTERNAL_ERROR
            - ETCD_ERROR
            - QUOTA_EXCEEDED
          example: INVALID_REQUEST
        message:
          type: string
          description: 错误描述信息
        details:
          type: object
          additionalProperties: true
          description: 错误详细信息（可选）

  securitySchemes:
    JwtAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        使用 IAM 颁发的 JWT 访问令牌，携带在 Authorization 头部：
        Authorization: Bearer \<token\>
        token 中包含主体和租户信息，用于后端 RBAC 决策。

    AccessKeyAuth:
      type: apiKey
      in: header
      name: X-MSP-AccessKey
      description: |
        使用 AccessKey/SecretKey 进行 HMAC-SHA256 签名的访问方式：
        \- 在 X-MSP-AccessKey 头部携带 access key 标识；
        \- 请求使用 SecretKey 对 method \+ path \+ timestamp \+ body 进行 HMAC-SHA256 计算；
        \- 签名放在 X-MSP-Signature 头部，时间戳放在 X-MSP-Timestamp 头部（Unix 时间戳，秒级）；
        \- 服务端通过 IAM/网关校验签名与时间窗口（有效期 ±5 分钟）。
        
        签名计算方法：
        ```
        stringToSign = METHOD + "\n" + PATH + "\n" + TIMESTAMP + "\n" + SHA256(BODY)
        signature = HMAC-SHA256(secretKey, stringToSign)
        X-MSP-Signature = Base64(signature)
        ```

  responses:
    BadRequest:
      description: 请求格式错误、字段缺失或非法
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Unauthorized:
      description: 未认证或认证失败（401）
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: 资源不存在
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Forbidden:
      description: 权限不足（403）
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    InternalServerError:
      description: etcd 连接失败或内部错误
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
